# Environment Management Best Practices

## üìã ƒ∞√ßindekiler

1. [Mevcut Durum](#mevcut-durum)
2. [Temel Prensipler](#temel-prensipler)
3. [Gelecek ƒ∞yile≈ütirmeler](#gelecek-iyile≈ütirmeler)
4. [G√ºvenlik √ñnerileri](#g√ºvenlik-√∂nerileri)
5. [Ortam Bazlƒ± Yapƒ±landƒ±rma](#ortam-bazlƒ±-yapƒ±landƒ±rma)
6. [CI/CD Entegrasyonu](#cicd-entegrasyonu)

---

## üéØ Mevcut Durum

### Yapƒ±landƒ±rma Dosyalarƒ±

Projemizde environment deƒüi≈ükenleri i√ßin a≈üaƒüƒ±daki yapƒ± kullanƒ±lmaktadƒ±r:

```
.
‚îú‚îÄ‚îÄ .env                    # Aktif environment deƒüi≈ükenleri (Git'e eklenmez)
‚îú‚îÄ‚îÄ .env.example           # Template dosyasƒ± (Git'e eklenir)
‚îú‚îÄ‚îÄ docker-compose.yml     # Altyapƒ± servisleri i√ßin
‚îî‚îÄ‚îÄ docker-compose-complete.yml  # T√ºm mikroservisler ile
```

### Environment Deƒüi≈ükenleri Kullanƒ±mƒ±

Docker Compose dosyalarƒ±nda environment deƒüi≈ükenleri ≈üu formatta kullanƒ±lƒ±r:

```yaml
environment:
  POSTGRES_USER: ${POSTGRES_USER:-fabric_user}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fabric_password}
```

**Format:** `${VARIABLE_NAME:-default_value}`

- `.env` dosyasƒ±nda tanƒ±mlƒ±ysa o deƒüeri kullanƒ±r
- Tanƒ±mlƒ± deƒüilse default deƒüeri kullanƒ±r

---

## üîê Temel Prensipler

### 1. 12-Factor App Metodolojisi

Environment configuration'ƒ± [12-Factor App](https://12factor.net/) prensiplerine g√∂re y√∂netiyoruz:

- ‚úÖ **Separation of Config from Code:** Konfig√ºrasyon koddan ayrƒ±
- ‚úÖ **Environment Parity:** T√ºm ortamlar aynƒ± yapƒ±yƒ± kullanƒ±r
- ‚úÖ **No Secrets in Code:** Hassas bilgiler kodda deƒüil, environment'ta

### 2. G√ºvenlik ƒ∞lkeleri

- ‚ùå **Asla `.env` dosyasƒ±nƒ± Git'e eklemeyin**
- ‚úÖ `.env.example` kullanarak template saƒülayƒ±n
- ‚úÖ Hassas bilgileri ≈üifreleyin veya secret manager kullanƒ±n
- ‚úÖ Production ortamƒ±nda g√º√ßl√º ≈üifreler kullanƒ±n

### 3. Dok√ºmantasyon

- Her environment deƒüi≈ükeni `.env.example`'da a√ßƒ±klanmalƒ±
- Deƒüi≈ükenlerin alabileceƒüi deƒüerler belirtilmeli
- Varsayƒ±lan deƒüerler g√ºvenli olmalƒ± (production i√ßin deƒüil)

---

## üöÄ Gelecek ƒ∞yile≈ütirmeler

### √ñncelik 1: Ortam Bazlƒ± Konfig√ºrasyon

#### Ama√ß

Farklƒ± ortamlar (development, staging, production) i√ßin ayrƒ± environment dosyalarƒ± olu≈üturmak.

#### Yapƒ±lacaklar

**1. Ortam bazlƒ± dosyalar olu≈ütur:**

```bash
.env.development    # Yerel geli≈ütirme
.env.staging        # Test ortamƒ±
.env.production     # Production ortamƒ±
```

**2. Docker Compose profiles kullan:**

```yaml
services:
  user-service:
    profiles: ["development", "production"]
    # ...
```

**3. Profil se√ßimi:**

```bash
# Development
docker-compose --profile development up

# Production
docker-compose --profile production up
```

#### Faydalarƒ±

- Ortamlar arasƒ± ge√ßi≈ü kolayla≈üƒ±r
- Her ortam i√ßin √∂zel ayarlar
- Hata riski azalƒ±r

#### Tahmini S√ºre

- **Uygulama:** 2-3 saat
- **Test:** 1 saat
- **Dok√ºmantasyon:** 30 dakika

---

### √ñncelik 2: Secret Management Entegrasyonu

#### Ama√ß

Hassas bilgileri (≈üifreler, API keyleri) g√ºvenli bir ≈üekilde y√∂netmek.

#### √ñnerilen √á√∂z√ºmler

**A. HashiCorp Vault (Self-hosted)**

```yaml
# docker-compose.yml
services:
  vault:
    image: vault:latest
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: myroot
    ports:
      - "8200:8200"
```

**Ïû•Ï†ê:**

- Merkezi secret y√∂netimi
- Encryption at rest
- Dynamic secrets
- Audit logging

**Uygulama Adƒ±mlarƒ±:**

1. Vault containerƒ±nƒ± ekle
2. Spring Cloud Vault entegrasyonu
3. Application.yml'de vault configuration
4. Secrets'i Vault'a ta≈üƒ±

**Tahmini Maliyet:** √úcretsiz (self-hosted)
**S√ºre:** 1-2 g√ºn

---

**B. AWS Secrets Manager (Cloud)**

```java
@Configuration
public class AwsSecretsConfig {
    @Bean
    public SecretsManagerClient secretsManager() {
        return SecretsManagerClient.builder()
            .region(Region.EU_WEST_1)
            .build();
    }
}
```

**Ïû•Ï†ê:**

- Managed service
- AWS ekosistemi entegrasyonu
- Otomatik rotation
- Fine-grained access control

**Uygulama Adƒ±mlarƒ±:**

1. AWS Secrets Manager'da secret olu≈ütur
2. Spring Cloud AWS entegrasyonu
3. IAM permissions ayarla
4. Application'da secrets √ßek

**Tahmini Maliyet:** ~$0.40/secret/month + API calls
**S√ºre:** 4-6 saat

---

**C. Docker Secrets (Docker Swarm)**

```yaml
# docker-compose.yml
secrets:
  db_password:
    external: true

services:
  postgres:
    secrets:
      - db_password
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
```

**Ïû•Ï†ê:**

- Docker native √ß√∂z√ºm
- Basit kullanƒ±m
- √úcretsiz

**Dezavantajlarƒ±:**

- Sadece Swarm mode
- Sƒ±nƒ±rlƒ± √∂zellikler

---

### √ñncelik 3: Configuration Validation

#### Ama√ß

Uygulama ba≈ülamadan environment deƒüi≈ükenlerini validate etmek.

#### Uygulama

**1. Spring Boot'ta validation:**

```java
@Configuration
@Validated
public class DatabaseConfig {

    @NotNull(message = "POSTGRES_HOST must be set")
    @Value("${POSTGRES_HOST}")
    private String host;

    @Min(value = 1024, message = "POSTGRES_PORT must be >= 1024")
    @Max(value = 65535, message = "POSTGRES_PORT must be <= 65535")
    @Value("${POSTGRES_PORT}")
    private Integer port;

    @NotBlank(message = "POSTGRES_PASSWORD cannot be empty")
    @Size(min = 12, message = "POSTGRES_PASSWORD must be at least 12 characters")
    @Value("${POSTGRES_PASSWORD}")
    private String password;
}
```

**2. Startup script ile validation:**

```bash
#!/bin/bash
# validate-env.sh

required_vars=(
    "POSTGRES_HOST"
    "POSTGRES_DB"
    "POSTGRES_USER"
    "POSTGRES_PASSWORD"
    "REDIS_HOST"
    "KAFKA_BOOTSTRAP_SERVERS"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "ERROR: $var is not set"
        exit 1
    fi
done

echo "‚úÖ All required environment variables are set"
```

#### Faydalarƒ±

- Erken hata yakalama
- A√ßƒ±klayƒ±cƒ± hata mesajlarƒ±
- Production sorunlarƒ±nƒ± √∂nler

**S√ºre:** 3-4 saat

---

### √ñncelik 4: Environment Variable Encryption

#### Ama√ß

`.env` dosyasƒ±ndaki hassas bilgileri ≈üifrelemek.

#### √ñnerilen Ara√ßlar

**A. git-crypt**

```bash
# Kurulum
brew install git-crypt

# GPG key ile init
git-crypt init

# .env dosyasƒ±nƒ± ≈üifrele
echo ".env filter=git-crypt diff=git-crypt" >> .gitattributes
git-crypt add .env

# Artƒ±k .env commit edilebilir (≈üifrelenmi≈ü olarak)
```

**Ïû•Ï†ê:**

- Transparent encryption/decryption
- Git workflow'a entegre
- Team collaboration kolay

---

**B. SOPS (Secrets OPerationS)**

```bash
# Kurulum
brew install sops

# .env dosyasƒ±nƒ± ≈üifrele
sops -e .env > .env.encrypted

# De≈üifrele
sops -d .env.encrypted > .env
```

**Ïû•Ï†ê:**

- Multiple key management (GPG, AWS KMS, GCP KMS, Azure Key Vault)
- YAML/JSON/ENV format desteƒüi
- Partial encryption (sadece value'lar)

---

**C. Ansible Vault**

```bash
# ≈ûifrele
ansible-vault encrypt .env

# De≈üifrele
ansible-vault decrypt .env

# D√ºzenle (≈üifrelenmi≈ü olarak)
ansible-vault edit .env
```

**Ïû•Ï†ê:**

- Ansible ile entegre
- Role-based access
- Basit kullanƒ±m

**√ñneri:** git-crypt (k√º√ß√ºk takƒ±mlar i√ßin) veya SOPS (cloud entegrasyonu i√ßin)

---

### √ñncelik 5: Dynamic Configuration

#### Ama√ß

Runtime'da configuration deƒüi≈üikliƒüi yapabilmek (restart olmadan).

#### Spring Cloud Config Entegrasyonu

**1. Config Server:**

```yaml
# config-server/docker-compose.yml
services:
  config-server:
    image: hyness/spring-cloud-config-server
    ports:
      - "8888:8888"
    environment:
      SPRING_CLOUD_CONFIG_SERVER_GIT_URI: https://github.com/yourorg/config-repo
    volumes:
      - ./config-repo:/config
```

**2. Client entegrasyonu:**

```yaml
# application.yml
spring:
  cloud:
    config:
      uri: http://config-server:8888
      fail-fast: true
```

**3. Refresh endpoint:**

```bash
# Configuration'ƒ± yeniden y√ºkle
curl -X POST http://localhost:8081/actuator/refresh
```

#### Faydalarƒ±

- Centralized configuration
- Restart gerektirmez
- Feature flag y√∂netimi
- A/B testing

**S√ºre:** 2-3 g√ºn

---

## üîí G√ºvenlik √ñnerileri

### Production Checklist

- [ ] T√ºm default ≈üifreler deƒüi≈ütirildi
- [ ] JWT secret key 256-bit ve g√º√ßl√º
- [ ] Database ≈üifreleri 16+ karakter, karma≈üƒ±k
- [ ] `.env` dosyasƒ± `.gitignore`'da
- [ ] Production credentials sadece production sunucusunda
- [ ] Secrets rotation politikasƒ± uygulandƒ±
- [ ] Access logs aktif
- [ ] Encryption at rest aktif (database, secrets)
- [ ] TLS/SSL sertifikalarƒ± ge√ßerli

### ≈ûifre Gereksinimleri

**Development:**

- Minimum 8 karakter
- B√ºy√ºk/k√º√ß√ºk harf + rakam

**Staging:**

- Minimum 12 karakter
- B√ºy√ºk/k√º√ß√ºk harf + rakam + √∂zel karakter

**Production:**

- Minimum 16 karakter
- B√ºy√ºk/k√º√ß√ºk harf + rakam + √∂zel karakter
- D√ºzenli rotation (90 g√ºn)
- Password manager ile y√∂netim

### Secrets Rotation

```bash
# Otomatik rotation scripti
#!/bin/bash
# rotate-secrets.sh

# Yeni ≈üifre olu≈ütur
NEW_PASSWORD=$(openssl rand -base64 32)

# Database'de g√ºncelle
psql -c "ALTER USER fabric_user WITH PASSWORD '$NEW_PASSWORD';"

# Secrets manager'da g√ºncelle
aws secretsmanager update-secret \
    --secret-id fabric-db-password \
    --secret-string "$NEW_PASSWORD"

# Servisleri restart et (yeni ≈üifreyi alsƒ±nlar)
docker-compose restart
```

---

## üåç Ortam Bazlƒ± Yapƒ±landƒ±rma

### Development Environment

```bash
# .env.development
SPRING_PROFILES_ACTIVE=development
POSTGRES_HOST=localhost
POSTGRES_PORT=5433
LOG_LEVEL=DEBUG

# Debug √∂zellikleri aktif
SPRING_DEVTOOLS_ENABLED=true
FLYWAY_CLEAN_DISABLED=false
```

**√ñzellikler:**

- Detaylƒ± logging
- Hot reload aktif
- Database clean izni var
- Mock services kullanƒ±labilir

---

### Staging Environment

```bash
# .env.staging
SPRING_PROFILES_ACTIVE=staging
POSTGRES_HOST=staging-db.internal
POSTGRES_PORT=5432
LOG_LEVEL=INFO

# Production benzeri ama izole
FLYWAY_CLEAN_DISABLED=true
```

**√ñzellikler:**

- Production benzeri setup
- Test i√ßin izole
- Real services
- Performans testleri

---

### Production Environment

```bash
# .env.production
SPRING_PROFILES_ACTIVE=production
POSTGRES_HOST=prod-db.internal
POSTGRES_PORT=5432
LOG_LEVEL=WARN

# Maximum g√ºvenlik
FLYWAY_CLEAN_DISABLED=true
ACTUATOR_ENDPOINTS_SENSITIVE=true
```

**√ñzellikler:**

- Minimum logging
- Maximum g√ºvenlik
- High availability
- Monitoring aktif
- Backup/recovery

---

## üîÑ CI/CD Entegrasyonu

### GitHub Actions √ñrneƒüi

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup Environment
        run: |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

      - name: Validate Environment
        run: ./scripts/validate-env.sh

      - name: Deploy
        run: docker-compose up -d
```

### Environment Variables Hierarchy

```
1. System Environment (highest priority)
   ‚Üì
2. .env file
   ‚Üì
3. docker-compose.yml environment
   ‚Üì
4. application.yml defaults (lowest priority)
```

---

## üìä Monitoring & Alerting

### √ñnerilen ƒ∞yile≈ütirmeler

**1. Configuration Changes Tracking**

```java
@EventListener(EnvironmentChangeEvent.class)
public void onEnvironmentChange(EnvironmentChangeEvent event) {
    log.info("Configuration changed: {}", event.getKeys());
    // Metrics'e g√∂nder
    metricsService.recordConfigChange(event);
}
```

**2. Secret Expiration Alerts**

```bash
# Alert scripti
#!/bin/bash
SECRET_AGE_DAYS=$(( ($(date +%s) - $(stat -f %B .env)) / 86400 ))

if [ $SECRET_AGE_DAYS -gt 90 ]; then
    echo "‚ö†Ô∏è  Secrets are $SECRET_AGE_DAYS days old. Rotation recommended!"
    # Slack webhook √ßaƒüƒ±r
fi
```

**3. Environment Drift Detection**

```python
# Ortamlar arasƒ±ndaki farklarƒ± tespit et
import difflib

dev_env = parse_env('.env.development')
prod_env = parse_env('.env.production')

diff = difflib.unified_diff(dev_env, prod_env)
if diff:
    alert("Environment drift detected!")
```

---

## üìö Kaynaklar ve Referanslar

### Dok√ºmantasyon

- [12-Factor App](https://12factor.net/)
- [Spring Boot External Configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)
- [Docker Compose Environment Variables](https://docs.docker.com/compose/environment-variables/)

### Ara√ßlar

- [HashiCorp Vault](https://www.vaultproject.io/)
- [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)
- [SOPS](https://github.com/mozilla/sops)
- [git-crypt](https://github.com/AGWA/git-crypt)

### Best Practices

- [OWASP Secrets Management](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)
- [Cloud Security Alliance Guidelines](https://cloudsecurityalliance.org/)

---

## üéØ Uygulama Roadmap

### Q1 2025 (√ñncelik: Y√ºksek)

- ‚úÖ `.env` ve `.env.example` yapƒ±sƒ± olu≈üturuldu
- ‚úÖ Docker Compose `.env` entegrasyonu tamamlandƒ±
- ‚úÖ `.gitignore` g√ºncellendi
- ‚è≥ Ortam bazlƒ± configuration dosyalarƒ± (.env.development, .env.production)
- ‚è≥ Environment validation scripti

### Q2 2025 (√ñncelik: Orta)

- ‚è≥ Secret Management √ß√∂z√ºm√º se√ßimi ve implementasyonu
- ‚è≥ Configuration validation (Spring Boot)
- ‚è≥ CI/CD pipeline'da environment y√∂netimi
- ‚è≥ Secrets rotation politikasƒ± ve otomasyonu

### Q3 2025 (√ñncelik: D√º≈ü√ºk)

- ‚è≥ Spring Cloud Config entegrasyonu
- ‚è≥ Dynamic configuration
- ‚è≥ Environment drift monitoring
- ‚è≥ Comprehensive documentation

---

## üìù Notlar

### G√ºncel Durum (01.10.2025)

- ‚úÖ Temel `.env` yapƒ±sƒ± kuruldu
- ‚úÖ Docker Compose dosyalarƒ± g√ºncellendi
- ‚úÖ Template (`.env.example`) olu≈üturuldu
- ‚ö†Ô∏è Eski `.env` dosyasƒ± yedeklendi (tarih damgalƒ±)

### Bilinen Sorunlar

- Hen√ºz secret management yok (≈üifreler plain text)
- Ortam bazlƒ± ayrƒ±m yok (tek `.env` dosyasƒ±)
- Validation mekanizmasƒ± yok

### Sonraki Adƒ±mlar

1. Ortam bazlƒ± dosyalar olu≈ütur
2. Validation scripti yaz
3. Secret management √ß√∂z√ºm√º ara≈ütƒ±r
4. CI/CD entegrasyonu planla

---

**Last Updated:** 2025-10-09 20:15 UTC+1  
**Version:** 1.0  
**Status:** ‚úÖ Active  
**Prepared By:** AI Assistant  
**Project:** Fabric Management System
