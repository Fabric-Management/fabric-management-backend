// Fabric Management Database Schema
// Bu dosyayı https://dbdiagram.io adresine yapıştırarak otomatik ERD oluşturabilirsiniz

Project fabric_management {
  database_type: 'PostgreSQL'
  Note: 'Fabric Management - Modular Monolith'
}

// ============================================================================
// COMMON PLATFORM TABLES
// ============================================================================

Table common_company {
  id uuid [pk]
  tenant_id uuid [note: 'Multi-tenant isolation']
  uid varchar [unique, note: 'Unique identifier']
  company_name varchar(255) [not null]
  tax_id varchar(50) [unique, not null]
  address varchar(500)
  city varchar(100)
  country varchar(100)
  phone_number varchar(50)
  email varchar(255)
  company_type varchar(50) [default: 'VERTICAL_MILL', note: '22 types: SPINNER, WEAVER, etc.']
  parent_company_id uuid [ref: > common_company.id, note: 'Self-referencing']
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Company/Tenant registry - 22 types (SPINNER, WEAVER, etc.)'
}

Table common_department {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  company_id uuid [ref: > common_company.id]
  department_name varchar(100) [not null]
  description varchar(500)
  manager_id uuid
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Organizational departments within companies'
}

Table common_user {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  first_name varchar(100) [not null]
  last_name varchar(100) [not null]
  display_name varchar(255) [not null]
  contact_value varchar(255) [unique, not null, note: 'Email or phone (E.164)']
  contact_type varchar(20) [not null, note: 'EMAIL or PHONE']
  company_id uuid [ref: > common_company.id]
  department varchar(100)
  last_active_at timestamp
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Platform users - NO username! contactValue is the identifier'
}

Table common_auth_user {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  contact_value varchar(255) [unique, not null]
  contact_type varchar(20) [not null]
  password_hash varchar(255) [not null, note: 'BCrypt hash']
  is_verified boolean [default: false]
  last_login_at timestamp
  failed_login_attempts integer [default: 0]
  locked_until timestamp
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Authentication credentials'
}

Table common_refresh_token {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  token varchar(255) [unique, not null]
  user_id uuid [ref: - common_auth_user.id]
  expires_at timestamp [not null]
  is_revoked boolean [default: false]
  revoked_at timestamp
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Refresh tokens for JWT token refresh flow'
}

Table common_subscription {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  os_code varchar(50) [not null]
  os_name varchar(255) [not null]
  status varchar(20) [default: 'TRIAL']
  pricing_tier varchar(50)
  start_date timestamp [not null]
  expiry_date timestamp
  trial_ends_at timestamp
  features jsonb [default: '{}']
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Tenant OS subscriptions'
}

Table common_subscription_quota {
  id uuid [pk]
  tenant_id uuid
  uid varchar [unique]
  subscription_id uuid [ref: > common_subscription.id]
  quota_type varchar(50) [not null]
  quota_limit bigint [not null]
  quota_used bigint [default: 0]
  reset_period varchar(20) [default: 'NONE']
  last_reset_at timestamp
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Usage limits and quotas per subscription'
}

// ============================================================================
// PRODUCTION SCHEMAS - FIBER REFERENCE DATA
// ============================================================================

Table prod_fiber_category {
  id uuid [pk]
  tenant_id uuid [default: '00000000-0000-0000-0000-000000000000', note: 'SYSTEM_TENANT']
  uid varchar [unique]
  category_code varchar(50) [unique, not null, note: 'NATURAL_PLANT, etc.']
  category_name varchar(100) [not null]
  description text
  display_order integer
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber categories - System-defined, tenant-independent'
}

Table prod_fiber_attribute {
  id uuid [pk]
  tenant_id uuid [default: '00000000-0000-0000-0000-000000000000']
  uid varchar [unique]
  attribute_code varchar(50) [unique, not null, note: 'DURABLE, BIODEGRADABLE, etc.']
  attribute_name varchar(100) [not null]
  attribute_group varchar(50) [note: 'PHYSICAL, CHEMICAL, ENVIRONMENTAL']
  description text
  display_order integer
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber attributes - System-defined'
}

Table prod_fiber_certification {
  id uuid [pk]
  tenant_id uuid [default: '00000000-0000-0000-0000-000000000000']
  uid varchar [unique]
  certification_code varchar(50) [unique, not null, note: 'GOTS, OEKO_TEX, etc.']
  certification_name varchar(100) [not null]
  certifying_body varchar(100)
  description text
  display_order integer
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber certifications - System-defined'
}

Table prod_fiber_iso_code {
  id uuid [pk]
  tenant_id uuid [default: '00000000-0000-0000-0000-000000000000']
  uid varchar [unique]
  iso_code varchar(10) [unique, not null, note: 'ISO 2076 codes: CO, PES, PA, etc.']
  fiber_name varchar(255) [not null]
  fiber_type varchar(100)
  description text
  is_official_iso boolean [default: true]
  display_order integer
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber ISO 2076 codes - Platform-level reference data'
}

// ============================================================================
// PRODUCTION SCHEMAS - FIBER BUSINESS DATA
// ============================================================================

Table prod_material {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique, not null]
  material_type varchar(20) [not null, note: 'FIBER, YARN, FABRIC, etc.']
  unit varchar(20) [not null]
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Material master data - READ-ONLY catalog'
}

Table prod_fiber {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique, not null]
  material_id uuid [unique, ref: - prod_material.id, note: '1:1 relation']
  fiber_category_id uuid [ref: - prod_fiber_category.id]
  fiber_iso_code_id uuid [ref: - prod_fiber_iso_code.id]
  fiber_name varchar(255) [not null]
  fiber_grade varchar(50)
  fineness double precision [note: 'For pure fibers only']
  length_mm double precision
  strength_cn_dtex double precision
  elongation_percent double precision
  status varchar(20) [default: 'NEW', note: 'NEW, IN_USE, EXHAUSTED, OBSOLETE']
  remarks text
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber instances - Can be pure (100%) or blended'
}

Table prod_fiber_composition {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique]
  blended_fiber_id uuid [ref: > prod_fiber.id, note: 'The blend']
  base_fiber_id uuid [ref: > prod_fiber.id, note: 'Component in blend']
  percentage numeric(5,2) [not null, note: 'Must sum to 100%']
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber blend composition - Many-to-Many'
}

Table prod_fiber_attribute_link {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique]
  fiber_id uuid [ref: > prod_fiber.id]
  attribute_id uuid [ref: > prod_fiber_attribute.id]
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber attributes - Many-to-Many'
}

Table prod_fiber_certification_link {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique]
  fiber_id uuid [ref: > prod_fiber.id]
  certification_id uuid [ref: > prod_fiber_certification.id]
  cert_number varchar(100)
  valid_from date
  valid_until date
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Fiber certifications - Many-to-Many'
}

// ============================================================================
// PRODUCTION EXECUTION
// ============================================================================

Table production_execution_fiber_batch {
  id uuid [pk]
  tenant_id uuid [not null]
  uid varchar [unique, not null]
  fiber_id uuid [ref: > prod_fiber.id]
  batch_code varchar(100) [not null]
  supplier_batch_code varchar(100)
  quantity decimal(15,3) [not null]
  unit varchar(20) [not null]
  production_date timestamp
  expiry_date timestamp
  status varchar(20) [default: 'NEW', note: 'NEW, RESERVED, IN_USE, DEPLETED']
  warehouse_location varchar(100)
  remarks text
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  created_by uuid
  updated_by uuid
  version bigint [default: 0]
  
  Note: 'Tracks physical fiber lots/batches for production execution'
}

// ============================================================================
// RELATIONSHIPS
// ============================================================================

Ref: common_user.company_id > common_company.id
Ref: common_department.company_id > common_company.id
Ref: common_subscription_quota.subscription_id > common_subscription.id
Ref: prod_fiber.material_id > prod_material.id
Ref: prod_fiber.fiber_category_id > prod_fiber_category.id
Ref: prod_fiber.fiber_iso_code_id > prod_fiber_iso_code.id
Ref: prod_fiber_composition.blended_fiber_id > prod_fiber.id
Ref: prod_fiber_composition.base_fiber_id > prod_fiber.id
Ref: prod_fiber_attribute_link.fiber_id > prod_fiber.id
Ref: prod_fiber_attribute_link.attribute_id > prod_fiber_attribute.id
Ref: prod_fiber_certification_link.fiber_id > prod_fiber.id
Ref: prod_fiber_certification_link.certification_id > prod_fiber_certification.id
Ref: production_execution_fiber_batch.fiber_id > prod_fiber.id

